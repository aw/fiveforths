<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Devlog 2 Dive Into The Code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <link rel="stylesheet" href="/css/main.css">
  
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" />
</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    
      <h1>FiveForths</h1>
    </a>
    <p style="text-align: center;">32-bit RISC-V Forth for microcontrollers</p>
    <div class="header-links">
      <a href="https://github.com/aw/fiveforths"><h2 class="header-link">Code</h2></a>
<a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/atom.xml"><h2 class="header-link">RSS</h2></a>
<a href="https://github.com/aw/fiveforths/archive/refs/heads/master.zip"><h2 class="header-link">Download</h2></a>
    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>Devlog 2 Dive Into The Code</h2>
  <h1 id="november-15-2022">November 15, 2022</h1>

<h2 id="dive-into-the-code">Dive into the code</h2>

<p>In this log entry, we’ll dive directly into the code and try to understand what’s been written so far, and why.</p>

<h3 id="log-2">Log 2</h3>

<p>Upon opening <code class="language-plaintext highlighter-rouge">fiveforths.s</code>, we’re immediately thrown into a long list of variables for use throughout the rest of the code. Afterwards, we’re greeted with macros to simplify our ASM code, followed by the actual functions and <em>Forth</em> words.</p>

<h4 id="variables-pt1">Variables, pt.1</h4>

<p>The first few variables hardcode some values used to define the size of the RAM, a cell, a stack, etc. We’ve seen seen the memory map in <a href="log-2022-11-14.md">Log 1</a>, and those addresses are defined relative to variables before them. This allows us to change one value and have the entire memory map adjusted automatically.</p>

<p>I found <code class="language-plaintext highlighter-rouge">fiveforths.ld</code> in this repo’s directory, but I hadn’t commited the file. I’m not sure where it came from so I’ll just keep using it for now. It hardcodes the FLASH and RAM addresses, as well as their sizes, making the variables somewhat redundant, but I’ll fix that once I have a better idea of what I’m doing.</p>

<p>I made some minor changes to the <code class="language-plaintext highlighter-rouge">Makefile</code> in order to link with that <em>layout</em> file, and I also modified the <code class="language-plaintext highlighter-rouge">_start</code> function to load the top of the stack address into the <code class="language-plaintext highlighter-rouge">sp</code> register. I did that because that’s where our stack pointer should be at the start of the program, but I’m getting a bit ahead of myself now. Back to the variables!</p>

<h4 id="variables-pt2">Variables, pt.2</h4>

<p>I used the <code class="language-plaintext highlighter-rouge">.space</code> directive to “reserve” the 1KiB stack spaces, but I think those might be completely unnecessary. I’ll probably remove them, again, once I have a better idea of what I’m doing.</p>

<p>Next, I reserved some space for the <code class="language-plaintext highlighter-rouge">STATE, HERE, LATEST, NOOP</code> variables, as well as some <code class="language-plaintext highlighter-rouge">PAD</code> area. The first 3 variables are commonly used by Forth, but <code class="language-plaintext highlighter-rouge">NOOP</code> is not. I don’t remember exactly why I created a <code class="language-plaintext highlighter-rouge">NOOP</code> variable but I’m sure I had a good reason, so I’ll leave it there for now. Same for the <code class="language-plaintext highlighter-rouge">PAD</code> area.</p>

<h4 id="registers">Registers</h4>

<p>Forth, by convention, uses some specific names for registers, and I mapped them to RISC-V registers as shown below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sp = DSP = data stack pointer
# a0 = W   = working register
# s0 = FP  = frame pointer (unused for now)
# s1 = IP  = instruction pointer
# s2 = RSP = return stack pointer
# s3 = TOS = top of stack pointer
# s4 = TIB = terminal input buffer
</code></pre></div></div>

<p>I mapped <code class="language-plaintext highlighter-rouge">TOS</code> to <code class="language-plaintext highlighter-rouge">s3</code>, a “saved register”, because it’s something I use a frequently in my implementation. This is one of the areas where I opted to do things a bit differently from <em>jonesforth</em> etc. I wanted to use one (1) specific register which always holds the top element in the stack. It seems like it might be needlessly juggling data around, particularly on an MCU where RAM access has practicaly zero-latency, but I kind of liked how it simplifies operations which only need the top element in the stack.</p>

<p>That might be changed in the future during the code optimization phase.</p>

<h4 id="macros">Macros</h4>

<p>I guess one of the good things about GNU AS is its support for macros. This makes the assembly code much simpler and easier to follow (in my opinion).</p>

<p>I’ve written a few macros such as <code class="language-plaintext highlighter-rouge">NEXT</code> and <code class="language-plaintext highlighter-rouge">defcode</code>, but I want to focus on <code class="language-plaintext highlighter-rouge">PUSH</code> and its friends. I made an early design decision to align things to 16 bytes (128-bit). That’s the requirement to be compliant with the RISC-V ABI, however I think that only applies for programs running on Linux, since there will be strict compatibility needs. On a microcontroller, 4-byte (32-bit) alignment might be more than enough, and less wasteful considering the limited resources. I’ll probably adjust that and align to 4-bytes like every other implementation.</p>

<p>Those macros are all implemented and fully functional, but I’m not sure what <code class="language-plaintext highlighter-rouge">RCALL</code> does so I’ll need to dig into my Forth books to refresh my memory.</p>

<h4 id="closing-thoughts">Closing thoughts</h4>

<p>I guess overall I have no idea what i’m doing. Jumping back into this incomplete/nonfunctional code after a year hiatus has been quite challenging, but I think I’ll soon be ready to pick up where I left off.</p>

<p>I’m getting tired after this mostly unproductive session, so I’ll discuss the functions and <em>Forth</em> words in the next log.</p>

  <div class="pagination">
    
      <a class="prev" href="/devlog-1-hello-world">&laquo; Devlog 1 Hello World</a>
    
    
      <a class="next" href="/devlog-3-deeper-into-the-rabbit-hole">Devlog 3 Deeper Into The Rabbit Hole &raquo;</a>
    
  </div>
</article>
      </section>
    </div>
  </div>

   <footer>
  <span>Copyright (c) 2021~ <a href="https://a1w.ca">Alexander Williams</a> and licensed under the permissive open source <a href="https://opensource.org/licenses/MIT">MIT</a> license.
  </span>
</footer>

</body>

</html>